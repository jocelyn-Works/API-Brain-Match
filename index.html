<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Quiz Duel Socket.IO</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="max-w-xl mx-auto p-6 mt-10 bg-white rounded-xl shadow-lg">
      <h1 class="text-2xl font-bold mb-6 text-center text-indigo-600">Quiz Duel Socket.IO</h1>

      <!-- FORMULAIRE -->
      <div class="mb-4">
        <label class="block mb-1 font-medium text-gray-700" for="playerId">Nom d'utilisateur</label>
        <input
          id="playerId"
          value="player1"
          class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
        />
      </div>

      <div class="mb-4">
        <label class="block mb-1 font-medium text-gray-700" for="categoryId">Choisis une cat√©gorie</label>
        <select
          id="categoryId"
          class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
        >
          <option disabled selected>Chargement des cat√©gories...</option>
        </select>
      </div>

      <button
        id="btnConnect"
        class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition"
      >
        Se connecter et rejoindre une partie
      </button>

      <!-- QUESTION CARD -->
      <div
        id="questionCard"
        class="mt-8 p-4 border rounded-md bg-gray-50"
        style="display: none"
      >
        <div class="flex justify-between mb-4 text-sm text-gray-600">
          <span id="scoreDisplay">Score : 0</span>
          <span id="timer">Temps : 10s</span>
        </div>
        <div id="questionText" class="text-lg font-semibold text-gray-800 mb-4"></div>
        <div id="answerButtons" class="grid grid-cols-1 gap-2"></div>
      </div>

      <!-- LOG -->
      <pre id="log" class="mt-6 text-sm bg-gray-100 p-3 rounded h-40 overflow-y-auto"></pre>
    </div>

    <script>
      const logEl = document.getElementById("log");
      const questionCard = document.getElementById("questionCard");
      const questionText = document.getElementById("questionText");
      const answerButtons = document.getElementById("answerButtons");
      const timerDisplay = document.getElementById("timer");
      const scoreDisplay = document.getElementById("scoreDisplay");
      const categorySelect = document.getElementById("categoryId");

      let socket;
      let questions = [];
      let currentQuestionIndex = 0;
      let timer;
      let timeLeft = 10;
      let score = 0;
      let hasAnswered = false;

      function log(msg) {
        logEl.textContent += msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
        console.log(msg);
      }

      async function loadCategories() {
        try {
          const res = await fetch("http://localhost:3000/api/quiz/category");
          const categories = await res.json();
          categorySelect.innerHTML =
            '<option disabled selected>Choisis une cat√©gorie</option>';

          categories.forEach((cat) => {
            const opt = document.createElement("option");
            opt.value = cat._id;
            opt.textContent = cat.theme;
            categorySelect.appendChild(opt);
          });
        } catch (err) {
          log("‚ùå Erreur de chargement des cat√©gories");
        }
      }

      function startTimer() {
        timeLeft = 10;
        timerDisplay.textContent = `Temps : ${timeLeft}s`;
        timer = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = `Temps : ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(timer);
            if (!hasAnswered) {
              log("‚è∞ Temps √©coul√©, r√©ponse non envoy√©e.");
              showNextQuestion();
            }
          }
        }, 1000);
      }

      function showQuestion() {
        const q = questions[currentQuestionIndex];
        hasAnswered = false;

        let html = `Question ${currentQuestionIndex + 1}: ${q.question}`;
        if (q.image) {
          html += `<div class="mt-2"><img src="${q.image}" class="max-w-full h-48 object-contain rounded border mt-2" /></div>`;
        }

        questionText.innerHTML = html;
        answerButtons.innerHTML = '';
        questionCard.style.display = 'block';
        startTimer();

        q.options.forEach((a, i) => {
          const btn = document.createElement("button");
          btn.textContent = a;
          btn.className =
            "px-4 py-2 bg-white border rounded hover:bg-indigo-100 transition text-left";
          btn.onclick = () => {
            if (hasAnswered) return;
            hasAnswered = true;
            clearInterval(timer);

            if (a === q.answer) {
              score++;
              updateScore();
              log(`‚úÖ Bonne r√©ponse : ${a}`);
              btn.classList.add("bg-green-200", "border-green-500");
            } else {
              log(`‚ùå Mauvaise r√©ponse. R√©ponse correcte : ${q.answer}`);
              btn.classList.add("bg-red-200", "border-red-500");
            }

            setTimeout(() => {
              showNextQuestion();
            }, 1500); // petite pause pour feedback visuel
          };
          answerButtons.appendChild(btn);
        });
      }

      function showNextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) {
          showQuestion();
        } else {
          log("üèÅ Fin du quiz !");
          questionCard.style.display = "none";
        }
      }

      function updateScore() {
        scoreDisplay.textContent = `Score : ${score}`;
      }

      document.getElementById("btnConnect").onclick = () => {
        const playerId = document.getElementById("playerId").value.trim();
        const categoryId = categorySelect.value;

        if (!categoryId) {
          log("‚ùå Choisis une cat√©gorie");
          return;
        }

        socket = io("http://localhost:3000");

        socket.on("connect", () => {
          log("‚úÖ Connect√© au serveur avec id: " + socket.id);

          socket.emit("join_game", {
            username: playerId,
            categoryId: categoryId,
          });

          log("üïπÔ∏è En attente d‚Äôun adversaire dans la cat√©gorie s√©lectionn√©e...");
        });

        socket.on("start_game", (data) => {
          const { roomId, players, quiz } = data;

          if (!quiz?.subTheme?.questions?.length) {
            log("‚ùå Aucune question re√ßue.");
            return;
          }

          questions = quiz.subTheme.questions;
          currentQuestionIndex = 0;
          score = 0;
          updateScore();

          log(
            `üéØ Partie lanc√©e dans ${roomId} contre ${players
              .map((p) => p.username)
              .join(" vs ")} !`
          );
          showQuestion();
        });

        socket.on("error", (err) => {
          log(`‚ùå Erreur : ${err.message}`);
        });
      };

      loadCategories();
    </script>
  </body>
</html>
